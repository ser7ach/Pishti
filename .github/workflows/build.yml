name: Build Pishti

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            output: Pishti.exe
          - os: ubuntu-latest
            output: Pishti
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Install Linux dependencies
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev xorg-dev libasound2-dev
    
    - name: Install fyne CLI
      run: go install fyne.io/tools/cmd/fyne@latest
    
    - name: Build with Fyne (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        fyne package -os windows -icon assets/ui/icon.png --release
        if (Test-Path "Pishti.exe") { Write-Output "Build successful" } else { Get-ChildItem }
    
    - name: Build with Fyne (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        fyne package -os linux -icon assets/ui/icon.png --release

        # Debug: see what's in the tarball
        echo "Tarball contents:"
        tar -tf Pishti.tar.xz
        
        # Extract the tarball
        tar -xf Pishti.tar.xz
        
        # Debug: see what was extracted
        echo "Contents after extraction:"
        find . -name "pishti" -type f
        find . -name "Pishti" -type f
        
        # Find and move the pishti binary (case insensitive search)
        PISHTI_PATH=$(find . -type f -iname "pishti" -executable | head -1)
        if [ -n "$PISHTI_PATH" ]; then
          echo "Found binary at: $PISHTI_PATH"
          mv "$PISHTI_PATH" ${{ matrix.output }}
          chmod +x ${{ matrix.output }}
          echo "Build successful"
        else
          echo "ERROR: Binary not found!"
          echo "All executable files:"
          find . -type f -executable
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pishti-${{ matrix.os }}
        path: ${{ matrix.output }}
        retention-days: 30